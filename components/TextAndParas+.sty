
% ##############################################
% Text / Para Settings and utils
% ##############################################


\ifluatex
    \usepackage{polyglossia} % helps with hyphenation
    \setdefaultlanguage[variant=canadian]{english}
\else
    \usepackage[english]{babel} % helps with hyphenation
\fi


\usepackage{csquotes} % helps with hyphenation and ""

%%% GENERAL FORMATTING
\usepackage{ragged2e}
\usepackage{blindtext}

%% Boxes and stuff
\usepackage[usestackEOL]{stackengine}  % used for title page and stacking things
\usepackage{setspace}  % enable onehalfspacing instyling
\usepackage{relsize}  % relative sizing
\usepackage{pbox}  % create box of max width http://ctan.mirror.colo-serv.net/macros/latex/contrib/pbox/pbox.pdf



\usepackage{fontawesome5}


\newcommand{\vparspace}{\vspace{\parskip}}

\def\tspc{\nobreak\hspace{.08em plus .04em}} % tiny space
\def\tspcs{\tspc{}s} % tiny space


\let\oldcenter\center
\let\oldendcenter\endcenter
\renewenvironment{center}{\setlength\topsep{0pt}\oldcenter}{\oldendcenter}  % removes extra sep

\let\oldflushleft\flushleft
\let\oldendflushleft\endflushleft
\renewenvironment{flushleft}{\setlength\topsep{0pt}\oldflushleft}{\oldendflushleft}

%% some latex stuff
\newcommand{\Llap}[1]{\leavevmode\llap{#1}}  % llap if first thing
\newcommand{\Rlap}[1]{\leavevmode\rlap{#1}}  % ..
\newcommand{\Clap}[1]{\leavevmode\clap{#1}}
\newcommand{\Hfill}{\null\hfill}  % hfill if first thing
\newcommand{\Vfill}{\null\vfill}  % hfill if first thing


\newcommand\ensurecomma{%
\@ifnextchar,{}{\@latex@error{Donâ€™t forget the comma!}{}}}
\newcommand\ex{e.g.\ensurecomma}
\let\eg\ex
\newcommand\ie{i.e.\ensurecomma}
\newcommand\ensuresingleperiod{\@ifnextchar.{}{.\@}}
\newcommand\etc{etc\ensuresingleperiod}
\newcommand\etal{et~al\ensuresingleperiod}



\usepackage[utf8]{luainputenc}

\DeclareUnicodeCharacter{2014}{\dash}
\AtBeginDocument{\pdfstringdefDisableCommands{\renewcommand{\dash}{ - }}}

\DeclareRobustCommand\dash{%
  \unskip\nobreak\thinspace\textemdash\allowbreak\thinspace\ignorespaces}

\DeclareRobustCommand\mdash{%
    \unskip\nobreak\thinspace\textemdash\thinspace\ignorespaces}

\DeclareRobustCommand\ndash{%
    \unskip\nobreak\thinspace\textendash\thinspace\ignorespaces}


\directlua{
  function autoemdash(s) return string.gsub(s,'[-][-][-]', '\string\\mdash ') end
  function autoendash(s) return string.gsub(s,'[=][-][-]', '\string\\ndash ') end
  function autodashes(s) return autoendash(autoemdash(s)) end
}

% todo trial replacement of unicode characters , eg. string.utfcharacter(0xFFFD)

\def\autoendash{\directlua{luatexbase.add_to_callback("process_input_buffer", autoendash,"auto spaced en dashes")}}
\def\autoemdash{\directlua{luatexbase.add_to_callback("process_input_buffer", autoemdash,"auto spaced em dashes")}}
\def\autodashes{\directlua{luatexbase.add_to_callback("process_input_buffer", autodashes,"auto spaced dashes")}}

\def\autoendashoff{\directlua{luatexbase.remove_from_callback("process_input_buffer","auto spaced en dashes")}}
\def\autoemdashoff{\directlua{luatexbase.remove_from_callback("process_input_buffer","auto spaced em dashes")}}
\def\autodashesoff{\directlua{luatexbase.remove_from_callback("process_input_buffer","auto spaced dashes")}}



% ##############################################
% Paragraph stretching and spacings
% ##############################################

% This is an suggestion from Axel Reichert (LaTeX package author)
% See CTAN: http://www.ctan.org/author/reichert
% See CTAN: http://www.ctan.org/pkg/l2tabu-english (Cgapter: 1.8 Should I use \sloppy?)

% 10000 is the highest
\tolerance=2800
\hbadness=1414
\emergencystretch=1.5em
\hfuzz=0.3pt
\widowpenalty=4000
\clubpenalty=4002
\brokenpenalty=101
\displaywidowpenalty=50
\vfuzz \hfuzz


%\if@twoside%
%	\raggedbottom
%\fi%  finally do nothing
%	\raggedbottom



