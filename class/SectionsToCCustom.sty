% ##############################################
% Section Headings
% ##############################################

%%% DEPENDENCIES
% KOMA-Script class
\usepackage{xcolor}
% ColorsCustom.sty
\usepackage{xpatch}
%%%



% ##############################################
% Table of Contents
% ##############################################

%%% DEPENDENCIES
% KOMA script class
%%%

%% ADJUST
% todo consider switching to latex

%%% EXTRA SPACE BEFORE SECTION AND START ON NEW PAGE

\RequirePackage{needspace}
\newlength{\secneedspace}
\setlength{\secneedspace}{15\baselineskip}
\newlength{\subsecneedspace}
\setlength{\subsecneedspace}{8\baselineskip}
\newlength{\subsubsecneedspace}
\setlength{\subsubsecneedspace}{5\baselineskip}

\RequirePackage{etoolbox}

\providetoggle{SecOnNewPage} %% only need one toggle
\toggletrue{SecOnNewPage}


\providetoggle{showListOfFigsTabs}
\providetoggle{samepgListOfFigsTabs}
\toggletrue{samepgListOfFigsTabs}



\newdimen\tocsecskip  %%% todo rename this
\tocsecskip=0.75em  % fit ToC as required

\newdimen\tocsubsecwidth
\newdimen\tocsubsubsecwidth

\newdimen\tocsubindent  % should auto adjust
\newdimen\tocsubsubindent  % should auto adjust

\tocsubsecwidth=4.4ex   % adjust this as needed. 4.6 is  good with single digit sections and no letter
\tocsubsubsecwidth=6.0ex   % adjust this as needed. 6.5 is  good with single digit sections and no letter (small size)

\tocsubsubindent=0ex
\addtolength{\tocsubsubindent}{\tocsubsecwidth}
\addtolength{\tocsubsubindent}{4pt}  % correction to account for small vs medium size


% diamond leaders.. staggered dots
\countdef\counter=255
\def\diamondleaders{\global\advance\counter by 1
	\ifodd\counter \kern-10pt \fi
	\leaders\hbox to 20pt{\ifodd\counter \kern13pt \else\kern3pt \fi
		.\hss}\hfil}


% Hanging section
%https://tex.stackexchange.com/questions/381261/right-align-chapter-numbering-in-koma-script-toc?rq=1
\newcommand\sectionentrynumberformat[1]{% define the new format for the chapter numbers in ToC
	% \renewcommand\autodot{.}% dot after chapter
	\hfill\smaller#1\enspace\hspace{1pt}% align chapter numbers right
}


% SECTION SPACING ON PAPER AND ToC - should change if section lettering is used
% determine if you should use baselineskip or not...

\RedeclareSectionCommand[beforeskip=21.pt plus 2.1pt,
afterskip=0.01pt,
%tocnumsep=1.5ex,
%tocdynnumwidth=switch,
tocindent=-4.3ex,
tocnumwidth=4ex,
 tocbeforeskip=\tocsecskip,
tocentryformat=\large\bfseries,
tocentrynumberformat=\sectionentrynumberformat,
]{section}%
%
\RedeclareSectionCommand[beforeskip=17.1pt plus 1.71pt,  % 1.25 * 13.7 (baseline)
toclinefill=\diamondleaders,
afterskip=0.01pt,
tocindent=0pt,
tocbeforeskip=1pt,
tocnumwidth=\tocsubsecwidth,
tocentryformat=\normalsize,
tocentrynumberformat=\smaller,
]{subsection}%
%
\RedeclareSectionCommand[beforeskip=13.7pt plus 1.37pt,
toclinefill=\diamondleaders,
afterskip=0.01pt,
tocindent=\tocsubsecwidth,
tocnumwidth=\tocsubsubsecwidth,
tocentryformat=\small,
tocentrynumberformat=\smaller,
]{subsubsection}

\RedeclareSectionCommand[beforeskip=3.01pt,
afterskip=-4ex,
]{paragraph}


%%% if using list of tables and figures
\DeclareTOCStyleEntry[%
linefill=\diamondleaders,
indent=0pt,
numwidth=\tocsubsecwidth,
entryformat=\normalsize,
entrynumberformat=\smaller,
]{tocline}{table}


\DeclareTOCStyleEntry[%
linefill=\diamondleaders,
indent=0pt,
numwidth=\tocsubsecwidth,
entryformat=\normalsize,
entrynumberformat=\smaller,
]{tocline}{figure}

%%%  How to use in document:
%    \listoffigures
%\renewcommand{\SecOnNewPage}{no}  % only if you want these on the same page...
%    \listoftables
%\renewcommand{\SecOnNewPage}{yes}


\setkomafont{disposition}{\normalfont\bfseries} % section preference





\if@twoside% if two-sided, put the section headings to right side and numbers in right margin
	\raggedbottom
\fi%  finally do nothing
	\raggedbottom




%%% SECTION NUMBERS IN MARGIN OF PAGE, for two sided documents
% Check if two-sided https://tex.stackexchange.com/questions/360785/how-do-i-check-if-a-document-is-oneside-or-twoside  %
%%% for flipped sections heads, kind of ugly
%\makeatletter % https://tex.stackexchange.com/questions/470752/section-numbers-in-margins-in-double-sided-document
%%preamble
%\if@twoside% if two-sided, put the section headings to right side and numbers in right margin
%\renewcommand\sectionlinesformat[4]{%  for section numbers in right margin for a two sided document
%	\ifthispageodd
%	{\raggedleft#4\makebox[0pt][l]{\hspace{\marginparsep}\smaller#3}}
%	{\raggedright\makebox[0pt][r]{\smaller#3\hspace{\marginparsep}}#4}%
%}
%%\newcommand\side{stuff for twoside} %todo reconsider if this is needed
%\else% if not two sided, only apply to one sided
%\renewcommand\sectionlinesformat[4]{% used by free-standing headings with style=section
%	\makebox[0pt][r]{\smaller#3}#4%  puts section number in margin
%}	%\newcommand\side{stuff for onside} %todo reconsider if this is needed
%\fi%  finally do nothing
%\makeatother


\renewcommand\sectionlinesformat[4]{% used by free-standing headings with style=section
	\makebox[0pt][r]{\smaller#3\hspace{3pt}}#4%  puts section number in margin
}

%%% SECTION NUMBER SPACING:
% \renewcommand*\sectionformat{\thesection\autodot\hspace{5mm}} % maybe 14pt enspace?


%%% SECTION NUMBER AND HEADING COLOR CHANGE
%\addtokomafont{chapter}{\color{secCol}}

\addtokomafont{section}{\color{secCol}}
\addtokomafont{subsection}{\color{subsecCol}}
\addtokomafont{subsubsection}{\color{subsubsecCol}}


\newdimen\sectprespacelength
\sectprespacelength=-20pt  % make less negative to increase spacing on new section title (always starts new page)

\newcounter{sectionletter}%
\newcommand{\resetsectionletter}{\setcounter{sectionletter}{0}}
\let\oldsection\section

\RenewDocumentCommand{\section}{ s t+ t! o m }{%
    %   * (no number, no ToC),  + (add sec letter) ! (on new page)
    \IfBooleanT{#3}{\invtoggle{SecOnNewPage}}%
    \IfBooleanTF{#2}{%
        	\ifnum\value{sectionletter}>0% if we're into section lettering already
        	    \addtocounter{section}{-1}% decrement section so num stays the same
        	\fi%
        	\stepcounter{sectionletter}% increment section letter
    }{\resetsectionletter}%
    \Needspace{\secneedspace}%
    \iftoggle{SecOnNewPage}{\clearpage\vspace*{\sectprespacelength}}{}%
    \expanded{%
        \noexpand\oldsection%
        \IfBooleanT{#1}{*}%
        \IfValueT{#4}{\unexpanded{[#4]}}%
        \unexpanded{{#5}}%
    }%
    \IfBooleanT{#3}{\invtoggle{SecOnNewPage}}%
}
\def\thesection{\arabic{section}\alph{sectionletter}}
\def\theHsection{\arabic{section}\alph{sectionletter}} % this is for hyperref (it does nothing if not loaded)

%
%\newdimen\sectprespacelength
%\sectprespacelength=-20pt  % make less negative to increase spacing on new section title (always starts new page)
%\xpretocmd\sectionlinesformat
%{\ifstr{#1}{section}{%
%    \iftoggle{SecOnNewPage}{\clearpage\vspace*{\sectprespacelength}}{}%
%}{}}  % THIS IS AUTOMATICALLY CHANGED IN APPENDIX
%{}{\PatchFailed}

%{\ifstr{#1}{section}{\ifdefstring{\SecOnNewPage}{yes}{\clearpage\vspace*{\sectprespacelength}}{}}{}}  % THIS IS AUTOMATICALLY CHANGED IN APPENDIX





\newcounter{subsectionletter}%
\newcommand{\resetsubsectionletter}{\setcounter{subsectionletter}{0}}
\let\oldsubsection\subsection

\RenewDocumentCommand{\subsection}{ s t+ t! o m }{%
    %   * (no number, no ToC),  + (add sec letter)
    \IfBooleanTF{#2}{%
        	\ifnum\value{subsectionletter}>0% if we're into subsection lettering already
        	    \addtocounter{subsection}{-1}% decrement subsection so num stays the same
        	\fi%
        	\stepcounter{subsectionletter}% increment subsection letter
    }{\resetsubsectionletter}%
    \Needspace{\subsecneedspace}%
    \expanded{%
        \noexpand\oldsubsection%
        \IfBooleanT{#1}{*}%
        \IfValueT{#4}{\unexpanded{[#4]}}%
        \unexpanded{{#5}}%
    }%
}
\def\thesubsection{\arabic{section}\alph{sectionletter}.\arabic{subsection}\alph{subsectionletter}}
\def\theHsubsection{\arabic{section}\alph{sectionletter}.\arabic{subsection}\alph{subsectionletter}}






\newcounter{subsubsectionletter}%
\newcommand{\resetsubsubsectionletter}{\setcounter{subsubsectionletter}{0}}
\let\oldsubsubsection\subsubsection

\RenewDocumentCommand{\subsubsection}{ s t+ t! o m }{%
    %   * (no number, no ToC),  + (add sec letter)
    \IfBooleanTF{#2}{%
        	\ifnum\value{subsubsectionletter}>0% if we're into subsubsection lettering already
        	    \addtocounter{subsubsection}{-1}% decrement subsubsection so num stays the same
        	\fi%
        	\stepcounter{subsubsectionletter}% increment subsubsection letter
    }{\resetsubsubsectionletter}%
    \Needspace{\subsubsecneedspace}%
    \expanded{%
        \noexpand\oldsubsubsection%
        \IfBooleanT{#1}{*}%
        \IfValueT{#4}{\unexpanded{[#4]}}%
        \unexpanded{{#5}}%
    }%
}
\def\thesubsubsection{\arabic{section}\alph{sectionletter}.\arabic{subsection}\alph{subsectionletter}.\arabic{subsubsection}\alph{subsubsectionletter}}
% this is for hyperref (it does nothing if not loaded)
\def\theHsubsubsection{\arabic{section}\alph{sectionletter}.\arabic{subsection}\alph{subsectionletter}.\arabic{subsubsection}\alph{subsubsectionletter}}





\let\oldparagraph\paragraph
%
\RenewDocumentCommand\paragraph{ s t! o m }{% add ! option for paragraph to allow header on its own line
    \edef\scr@paragraph@afterskip {%
        \IfBooleanTF{#2}{0.1pt}{-4ex}%
    }%
    \expanded{%
        \noexpand\oldparagraph
            \IfBooleanT{#1}{*}%
            \IfValueT{#3}{\unexpanded{[#3]}}%
            \unexpanded{{#4}}%
    }%
}
%

%\newcommand{\se}{def}

%%%% FOR BLANK PAGE ON LEFT SIDE WHEN NEW SECTION STARTS:
%\newcommand{\IntentBlank}{\vspace*{\fill}
%	{\noindent\large\centering This Page Intentionally Left Blank \\[5cm]}
%	\vspace*{\fill}}
	%%% https://tex.stackexchange.com/questions/102451/have-cleardoublepage-working-in-oneside-scrreprt
%\newcommand\cleartooddpage{\clearpage
%	\ifodd\value{page}\else\null\IntentBlank\clearpage\fi}
%\let\secSame\section  % section on same page 
%\pretocmd{\section}{\cleartooddpage}{}{}


%%% USED IN SCRBOOK AND SCRREPRT
%\renewcommand*\othersectionlevelsformat[3]{%
%	\llap{#3\autodot\enskip}%
%}
%\renewcommand*{\chapterformat}{%
%	{\fontsize{20}{30}\scshape\chapappifchapterprefix{}}%
%	\fontsize{120}{30}\selectfont\rlap{\thechapter\autodot}%
%}


