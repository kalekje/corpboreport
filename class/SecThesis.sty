%\clearpairofpagestyles
\providecommand{\cbp@secnumsize}{}



% ##############################################
% Table of Contents
% ##############################################

\newdimen\tocsecskip  %%% todo rename this
\tocsecskip=0.75em  % fit ToC as required


% diamond leaders.. staggered dots
\countdef\counter=255
\def\diamondleaders{\global\advance\counter by 1
	\ifodd\counter \kern-10pt \fi
	\leaders\hbox to 20pt{\ifodd\counter \kern13pt \else\kern3pt \fi
		.\hss}\hfil}


%%% EXTRA SPACE BEFORE SECTION AND START ON NEW PAGE

\RequirePackage{needspace}
\newlength{\secneedspace}
\setlength{\secneedspace}{8\baselineskip}
\newlength{\subsecneedspace}
\setlength{\subsecneedspace}{6\baselineskip}
\newlength{\subsubsecneedspace}
\setlength{\subsubsecneedspace}{4\baselineskip}




%%% HEADER
\renewcommand{\chaptermark}[1]{%
  \markboth{\chapapp\ \thechapter\autodot}{#1}}
\renewcommand{\addchapmark}[1]{\markboth{#1}{#1}}




% ##############################################
% Section Headings
% ##############################################


%%% CHAPTER SECTION HEADINGS FORMAT


\addtokomafont{chapterprefix}{\raggedleft\toglnums}
%\addtokomafont{pagenumber}{\toglnums}

%https://tex.stackexchange.com/questions/43619/changing-toc-subsection-entry-font-in-scrartcl
\newcommand\tocmainfont[1]{%
  \toglnums #1%
}

\newcommand{\ShowChapterPrefix}{
\renewcommand*{\chapterformat}{%
\color{brown}%
\mbox{\raisebox{5ex}{\normalsize
\chapappifchapterprefix
{\nobreakspace}}%
\scalebox{3}{\thechapter\autodot}\enskip}}
}%

\newcommand{\HideChapterPrefix}{
\renewcommand*{\chapterformat}{%
\color{brown}%
\mbox{\scalebox{3}{\thechapter\autodot}\enskip}}}%

\HideChapterPrefix


% Hanging section, % NUMBERS IN LEFT MARGIN
%https://tex.stackexchange.com/questions/381261/right-align-chapter-numbering-in-koma-script-toc?rq=1
\renewcommand\sectionlinesformat[4]{%
	\makebox[0pt][r]{\cbp@secnumsize#3\hspace{2pt}}#4%
}
\renewcommand\sectioncatchphraseformat[4]{% used by run-in headings with style=section
	\makebox[0pt][r]{\cbp@secnumsize#3\hspace{1pt}}#4%
}

%https://tex.stackexchange.com/questions/381261/right-align-chapter-numbering-in-koma-script-toc?rq=1
\newcommand\sectionentrynumberformat[1]{% define the new format for the chapter numbers in ToC
	\hfill\cbp@secnumsize#1\enspace\hspace*{0.01pt}% align chapter numbers right
}


\setkomafont{disposition}{\normalfont\bfseries} % section preference
\newcommand{\vparspace}{\vspace{\parskip}}


% https://umanitoba.ca/sites/default/files/2019-12/UM_Brand-Guidelines.pdf
\definecolor{brown}{RGB}{79, 44, 29}
\definecolor{darkblue}{RGB}{56, 94, 157}
\definecolor{lightblue}{RGB}{0, 163, 224}
\definecolor{yellow}{RGB}{242, 169, 0}



\addtokomafont{chapter}{\color{brown}}
\addtokomafont{section}{\color{brown}\Large}
\addtokomafont{subsection}{\color{brown}\large}
\addtokomafont{subsubsection}{\color{brown}\normalsize}
\addtokomafont{paragraph}{\color{brown}}


%%% TOC
\setcounter{tocdepth}{1} %%% TOC Depth

\RedeclareSectionCommand[
beforeskip=1.0\baselineskip plus 3pt minus 1pt,  % negative will suppress first indent
tocbeforeskip=1.2em plus 0.2em minus 1pt,
afterskip=15pt,
tocindent=-4ex,
tocnumwidth=4ex,
tocbeforeskip=16pt,
toclinefill=\diamondleaders,
tocentryformat=\large\bfseries,
tocentrynumberformat=\sectionentrynumberformat,
%tocpagenumberformat=\tocmainfont,
]{chapter}

\RedeclareSectionCommand[
beforeskip=1.0\baselineskip plus 3pt minus 1pt,  % negative will suppress first indent
afterskip=3pt,
tocbeforeskip=2pt,
tocindent=0.5ex,
tocnumwidth=6ex,
toclinefill=\diamondleaders,
tocentrynumberformat=\cbp@secnumsize,
tocentryformat=\large,
%tocpagenumberformat=\tocmainfont,
]{section}

\RedeclareSectionCommand[
beforeskip=2.0\baselineskip plus 4pt minus 2pt,
afterskip=0.01mm,%\baselineskip,
tocindent=6.5ex,
tocnumwidth=6ex,
toclinefill=\diamondleaders,
tocentrynumberformat=\cbp@secnumsize,
tocentryformat=\normalsize,
]{subsection}

\RedeclareSectionCommand[
beforeskip=1.0\baselineskip plus 4pt minus 2pt,
afterskip=0.01mm,
runin=false,  % text on same line
tocindent=6ex,
tocnumwidth=10ex,
tocentrynumberformat=\cbp@secnumsize,
tocentryformat=\small,
]{subsubsection}

\RedeclareSectionCommand[
beforeskip=.5\baselineskip,
afterskip=-1em]{paragraph}

\RedeclareSectionCommand[
beforeskip=-.5\baselineskip,
afterskip=-1em]{subparagraph}



\DeclareTOCStyleEntry[%
linefill=\diamondleaders,
indent=-5ex,
numwidth=5ex,
entryformat=\normalsize,
entrynumberformat=\cbp@secnumsize,
]{tocline}{table}
\renewcaptionname{english}{\listtablename}{Tables}


\DeclareTOCStyleEntry[%
linefill=\diamondleaders,
indent=-5ex,
numwidth=5ex,
entryformat=\normalsize,
entrynumberformat=\cbp@secnumsize,
]{tocline}{figure}
\renewcaptionname{english}{\listfigurename}{Figures}

% todo need something for code boxes?

%\setkomafont{tocentrypagenumber}{\toglnums}
%\addtokomafont{chapterentrypagenumber}{\toglnums}
%\setkomafont{sectionentrypagenumber}{\toglnums}
%\addtokomafont{entrypagenumber}{\toglnums}

%\addtokomafont{sectionentrypagenumber}{\toglnums}
% https://tex.stackexchange.com/questions/241210/fonts-used-in-scrrprt-toc

%\usepackage{tocstyle}
%\settocstylefeature{pagenumberhook}{\toglnums}

\counterwithin{figure}{chapter}
\counterwithin{table}{chapter}


\def\cbp@largechapspace{\RedeclareSectionCommand[beforeskip=6.0\baselineskip plus 3pt minus 1pt]{chapter}}
\def\cbp@normalchapspace{\RedeclareSectionCommand[beforeskip=1.0\baselineskip plus 3pt minus 1pt]{chapter}}

% front matter chapter (acknowledgements or abstract)
\newcommand{\chapterF}[1]{\cbp@largechapspace
\pdfbookmark[0]{#1}{Label#1PDF}%
\chapter*{#1}%
\cbp@normalchapspace}


\NewDocumentCommand{\chapterM}{ t- m }{% chapter Matter (front or back), ToC and pdf bookmark but no number
  \IfBooleanT{#1}{\addtocontents{toc}{\vspace*{-1.3ex}}}
  \chapter*{#2}
  \addtocentrydefault{chapter}{\phantom{.}}{#2}{}
  \chaptermark{#2}%
}

\def\frontmatter{
  \pdfbookmark[-1]{Front-Matter}{LabelFMPDF}
  \pdfbookmark[0]{Title}{LabelTitlePDF}
}



\def\addcontentslists{
  \pdfbookmark[0]{Contents}{LabelContentsPDF}
  \tableofcontents
  \chaptermark{Contents}
  
  \addtocentrydefault{chapter}{\phantom{.}}{Figures}\addtocontents{toc}{\vspace*{-1.3ex}}%
  \listoffigures
  \chaptermark{Figures}
%
  \addtocentrydefault{chapter}{\phantom{.}}{Tables}%
  \listoftables
  \chaptermark{Tables}
}

\def\mainmatter{\bookmarksetup{startatroot}}

\def\backmatter{\pdfbookmark[-1]{Back-Matter}{LabelBMPDF}}



%% BACK MATTER
%\HideChapterPrefix
%\addtocontents{toc}{Back-Matter}

